---
title: "Marian_SM_weekly_avgs_July2021"
author: "Simon Marks"
date: "7/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate)
library(data.table)
library(openair)
```

## Latest Marian Compilation Data (Nov 2020)

```{r}

# Marian

Marian_SM_July2021 <- readr::read_csv("Marian_SM_July2021/compiled_Marian_July2021.csv", col_types = cols(Date = col_character(), .default = col_double())) %>% 
  dplyr::mutate(Date = as.POSIXct(Date, tz = "UTC"))

```

## Filtering Out Bad SM Data

* VWC values less than or equal to 0 or greater than 0.7 (Note that 1 meter depth for MMSM1 is stuck at approx. 0.7 VWC starting at week of 2019-08-02)

```{r}

Marian_SM_good_data_July2021 <- Marian_SM_July2021 %>%
  dplyr::mutate(dplyr::across(starts_with("VWC"), ~ case_when(
    . <= 0 | . > 0.7 ~ NA_real_,
    TRUE ~ .
  )))
```

## Temporal Averaging Function

```{r}

temp_agg_meadow_dat <- function(data, start_day_of_week, interval = "30 min", avg.time = "7 day", data.thresh = 25, statistic = "mean"){
  
  # data <- readr::read_csv(path, col_types = cols(Date = col_character(), .default = col_double())) %>% 
  #   dplyr::mutate(Date = as.POSIXct(Date, tz = "UTC"))
  
  # path_write_out <- paste0(stringr::str_replace(path, "[^/]+$", replacement = ""), file_name_write)
  
  # Determine the dates corresponding to the first and last of chosen weekday (start date for averaging) present in data
  start_date <- data %>% 
    dplyr::mutate(is.chosen_wday = ifelse(lubridate::wday(Date) == start_day_of_week, T, F)) %>%
    dplyr::filter(is.chosen_wday == TRUE) %>% 
    dplyr::summarise(min(Date)) %>% 
    dplyr::pull()
  
  end_date <- data %>% 
    dplyr::mutate(is.chosen_wday = ifelse(lubridate::wday(Date) == start_day_of_week - 1, T, F)) %>%
    dplyr::filter(is.chosen_wday == TRUE) %>% 
    dplyr::summarise(max(Date)) %>% 
    dplyr::pull()
  
  data <- data %>% 
    # rename Date variable to "date" to play nicely w/ openair::timeAverage
    dplyr::rename(date = Date) %>% 
    dplyr::filter(date >= start_date & date <= end_date)
  
  aggregation <- openair::timeAverage(data, avg.time = avg.time, 
                                      data.thresh = data.thresh, statistic = statistic,
                                      start.date = start_date, end.date = end_date, interval = interval) %>% 
    # determine water year membership of the time avg- this might need to be tweaked
    dplyr::mutate(WY = dplyr::case_when(
      date %within% lubridate::interval(ymd("2017-10-01", tz = "UTC"), 
                                        ymd("2018-09-30", tz = "UTC")) ~ 2018,
      date %within% lubridate::interval(ymd("2018-10-01", tz = "UTC"), 
                                        ymd("2019-09-30", tz = "UTC")) ~ 2019,
      date %within% lubridate::interval(ymd("2019-10-01", tz = "UTC"), 
                                        ymd("2020-09-30", tz = "UTC")) ~ 2020,
      date %within% lubridate::interval(ymd("2020-10-01", tz = "UTC"), 
                                        ymd("2021-09-30", tz = "UTC")) ~ 2021,
    )) 
  # %>% 
  #   mutate(date = as.character(date)) %>% 
  #   rename(Date = date) %>%  
  #   # Write to .csv
  #   readr::write_csv(path = path_write_out)
  
}

```

## Weekly Averages- Marian

* First instruments at Marian were well installed on September 13 of 2013 (Friday), so `start_day_of_week = 6`
* Maintains all other default arguments from above functions

**First week is week of 2019-04-26, last week is week of 2021-6-25*

```{r}

weekly_Marian_SM_toJuly2021 <- temp_agg_meadow_dat(Marian_SM_good_data_July2021, interval = "30 min", start_day_of_week = 6, data.thresh = 25) %>% 
  dplyr::mutate(across(starts_with("VWC"), ~round(.x, digits = 3)))

# write out to CSV

weekly_Marian_SM_toJuly2021 %>% 
    mutate(date = as.character(date)) %>%
    rename(Date = date) %>%
    readr::write_csv(path = "Marian_SM_July2021/weekly_SM_Marian_July2021.csv")


```

